### command for running python script with faulthandler for better logs
```
$ python3 -q -X faulthandler segfault.py
```

### command for running python in gdb
```
$ gdb --args /usr/bin/python3.9 segfault.py
$ gdb --args /usr/bin/python3.9 -m pdb segfault.py
```
or -ex r for running on start
```
$ gdb -ex r --args /usr/bin/python3.9 segfault.py
$ gdb -ex r --args /usr/bin/python3.9 -m pdb segfault.py
```

### debugging commands for python in gdb
- stack trace of c stuff?
```
(gdb) bt
```
- get stack trace of python code
```
(gdb) py-bt
```
- get information about all threads
```
(gdb) info threads
```
- see where current thread is in code
```
(gdb) py-list
```
- see where all threads are currently in code
```
(gdb) thread apply all py-list
```

### example debugging
- load script into gdb
```
$ gdb --args /usr/bin/python3.9 segfault.py
```
- run script in gdb
```
(gdb) r
Starting program: /usr/bin/python3 segfault.py
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff48da700 (LWP 13833)]
[New Thread 0x7fffec0d9700 (LWP 13834)]
[New Thread 0x7fffeb8d8700 (LWP 13835)]
[New Thread 0x7fffe30d7700 (LWP 13836)]
[New Thread 0x7fffda8d6700 (LWP 13837)]
[New Thread 0x7fffca0d5700 (LWP 13838)]
[New Thread 0x7fffc18d4700 (LWP 13839)]
call, /home/robert/repos/exploits/python_code/segfault.py:42
line, /home/robert/repos/exploits/python_code/segfault.py:43
call, /home/robert/repos/exploits/python_code/segfault.py:25
line, /home/robert/repos/exploits/python_code/segfault.py:26
call, /usr/lib/python3.9/ctypes/__init__.py:513
line, /usr/lib/python3.9/ctypes/__init__.py:517

Thread 1 "python3" received signal SIGSEGV, Segmentation fault.
__strlen_avx2 () at ../sysdeps/x86_64/multiarch/strlen-avx2.S:65
65      ../sysdeps/x86_64/multiarch/strlen-avx2.S: No such file or directory.
```
- get backtrace of program
```
(gdb) bt
#0  __strlen_avx2 () at ../sysdeps/x86_64/multiarch/strlen-avx2.S:65
#1  0x00007ffff77ef8bb in string_at (ptr=0x0, size=-1) at ./Modules/_ctypes/_ctypes.c:5583
#2  0x00007ffff7fbfd1d in ?? () from /lib/x86_64-linux-gnu/libffi.so.7
[...]
```
- select frame for further investigation
```
(gdb) frame 1
#1  0x00007ffff77ef8bb in string_at (ptr=0x0, size=-1) at ./Modules/_ctypes/_ctypes.c:5583
5583    ./Modules/_ctypes/_ctypes.c: No such file or directory.
```
```
(gdb) list
5578    in ./Modules/_ctypes/_ctypes.c
```
- print info about method where seg fault happens
```
(gdb) p string_at
$1 = {PyObject *(const char *, int)} 0x7ffff77ef884 <string_at>
```
- get layout
```
(gdb) layout asm
[...]
|   0x7ffff77ef8b3 <string_at+47>   mov    %rbp %rdi
│   0x7ffff77ef8b6 <string_at+50>   call   0x7ffff77e8290 <strlen@plt>
│  >0x7ffff77ef8bb <string_at+55>   mov    %rax,%rsi
│   0x7ffff77ef8be <string_at+58>   pop    %rcx  
[...]
```
- get info about shared libs
```
(gdb) info sharedlibrary
```
- disassemble function where program crashed
```
(gdb) disas
Dump of assembler code for function string_at:
   0x00007ffff77ef884 <+0>:     push   %rbp
   0x00007ffff77ef885 <+1>:     mov    %rdi,%rbp
   0x00007ffff77ef888 <+4>:     mov    %esi,%ecx
   0x00007ffff77ef88a <+6>:     mov    %rdi,%rdx
   0x00007ffff77ef88d <+9>:     push   %rbx
   0x00007ffff77ef88e <+10>:    xor    %eax,%eax
   0x00007ffff77ef890 <+12>:    mov    %esi,%ebx
   0x00007ffff77ef892 <+14>:    lea    0xb7ca(%rip),%rdi        # 0x7ffff77fb063
   0x00007ffff77ef899 <+21>:    push   %r8
   0x00007ffff77ef89b <+23>:    lea    0xb7be(%rip),%rsi        # 0x7ffff77fb060
   0x00007ffff77ef8a2 <+30>:    call   0x7ffff77e86a0 <PySys_Audit@plt>
   0x00007ffff77ef8a7 <+35>:    test   %eax,%eax
   0x00007ffff77ef8a9 <+37>:    js     0x7ffff77ef8c9 <string_at+69>
   0x00007ffff77ef8ab <+39>:    movslq %ebx,%rsi
   0x00007ffff77ef8ae <+42>:    cmp    $0xffffffff,%ebx
   0x00007ffff77ef8b1 <+45>:    jne    0x7ffff77ef8be <string_at+58>
   0x00007ffff77ef8b3 <+47>:    mov    %rbp,%rdi
   0x00007ffff77ef8b6 <+50>:    call   0x7ffff77e8290 <strlen@plt>
=> 0x00007ffff77ef8bb <+55>:    mov    %rax,%rsi
   0x00007ffff77ef8be <+58>:    pop    %rcx
   0x00007ffff77ef8bf <+59>:    mov    %rbp,%rdi
   0x00007ffff77ef8c2 <+62>:    pop    %rbx
   0x00007ffff77ef8c3 <+63>:    pop    %rbp
   0x00007ffff77ef8c4 <+64>:    jmp    0x7ffff77e81c0 <PyBytes_FromStringAndSize@plt>
   0x00007ffff77ef8c9 <+69>:    pop    %rdx
   0x00007ffff77ef8ca <+70>:    xor    %eax,%eax
   0x00007ffff77ef8cc <+72>:    pop    %rbx
   0x00007ffff77ef8cd <+73>:    pop    %rbp
   0x00007ffff77ef8ce <+74>:    ret    
End of assembler dump.
```

### deubg c extension in python code via gdb
- launch python3 in gdb
```
$ gdb python3
```
- set breakpoint in c function
```
(gdb) break string_at
```
- run python code
```
(gdb) run -m segfault.py
Starting program: /usr/bin/python3 -m segfault.py
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff489a700 (LWP 16213)]
[New Thread 0x7ffff4099700 (LWP 16214)]
[New Thread 0x7fffeb898700 (LWP 16215)]
[New Thread 0x7fffdb097700 (LWP 16216)]
[New Thread 0x7fffd2896700 (LWP 16217)]
[New Thread 0x7fffca095700 (LWP 16218)]
[New Thread 0x7fffc1894700 (LWP 16219)]
call, /home/robert/repos/exploits/python_code/segfault.py:42
line, /home/robert/repos/exploits/python_code/segfault.py:43
call, /home/robert/repos/exploits/python_code/segfault.py:25
line, /home/robert/repos/exploits/python_code/segfault.py:26
call, /usr/lib/python3.9/ctypes/__init__.py:513
line, /usr/lib/python3.9/ctypes/__init__.py:517

Thread 1 "python3" hit Breakpoint 1, string_at (ptr=0x0, size=-1)
    at ./Modules/_ctypes/_ctypes.c:5579
5579    ./Modules/_ctypes/_ctypes.c: No such file or directory.
```
- hit cont to step into next breakpoint or run program until crash/finish
```
(gdb) cont
```
- hit disas to dissamble last function
```
(gdb) disas
```

### another debug example of python code
- load program into gdb
```
$ gdb --args /usr/bin/python3.9 segfault.py
[...]
Reading symbols from /usr/bin/python3...
Reading symbols from /usr/lib/debug/.build-id/23/979cd82e8104807e7a6f742c379e49e7c5d9bb.debug...
```
- run script
```
(gdb) r
Starting program: /usr/bin/python3 segfault.py
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff48d8700 (LWP 5885)]
[New Thread 0x7fffec0d7700 (LWP 5886)]
[New Thread 0x7fffe38d6700 (LWP 5887)]
[New Thread 0x7fffdb0d5700 (LWP 5888)]
[New Thread 0x7fffd28d4700 (LWP 5889)]
[New Thread 0x7fffca0d3700 (LWP 5890)]
[New Thread 0x7fffc18d2700 (LWP 5891)]
call, /home/robert/repos/exploits/python_code/segfault.py:46
line, /home/robert/repos/exploits/python_code/segfault.py:48
call, /home/robert/repos/exploits/python_code/segfault.py:25
line, /home/robert/repos/exploits/python_code/segfault.py:26
call, /usr/lib/python3.9/ctypes/__init__.py:513
line, /usr/lib/python3.9/ctypes/__init__.py:517

Thread 1 "python3" received signal SIGSEGV, Segmentation fault.
__strlen_avx2 () at ../sysdeps/x86_64/multiarch/strlen-avx2.S:65
65      ../sysdeps/x86_64/multiarch/strlen-avx2.S: No such file or directory.
```
- get python stacktrace
```
(gdb) py-bt
Traceback (most recent call first):
  File "/usr/lib/python3.9/ctypes/__init__.py", line 517, in string_at
    return _string_at(ptr, size)
  File "/home/robert/repos/exploits/python_code/segfault.py", line 26, in example2
    ctypes.string_at(0)
  File "/home/robert/repos/exploits/python_code/segfault.py", line 48, in main
    example2()
  File "/home/robert/repos/exploits/python_code/segfault.py", line 50, in <module>
    main()
```
- move to desired frame
```
(gdb) py-up
#15 Frame 0x7ffff76ff040, for file /home/robert/repos/exploits/python_code/segfault.py, line 26, in example2 ()
    ctypes.string_at(0)
(gdb) py-down
#9 Frame 0x7ffff774c740, for file /usr/lib/python3.9/ctypes/__init__.py, line 517, in string_at (ptr=0, size=-1)
    return _string_at(ptr, size)
```
- get stack vars etc from desired frame (typically last frame where crash occurs)
```
(gdb) info locals
sp = <optimized out>
res = <optimized out>
__atomic_load_ptr = <optimized out>
__atomic_load_tmp = <optimized out>
stack_pointer = <optimized out>
next_instr = 0x7fffb8bf7448
opcode = <optimized out>
oparg = <optimized out>
fastlocals = <optimized out>
freevars = <optimized out>
retval = <optimized out>
ceval2 = <optimized out>
eval_breaker = <optimized out>
co = <optimized out>
instr_ub = 2147483647
instr_lb = 0
instr_prev = 6
first_instr = <optimized out>
names = <optimized out>
consts = <optimized out>
co_opcache = <optimized out>
main_loop = <optimized out>
fast_next_opcode = <optimized out>
exception_unwind = <optimized out>
__func__ = "_PyEval_EvalFrameDefault"
opcode_targets = {0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x51269b <_PyEval_EvalFrameDefault+2251>, 0x5138ed <_PyEval_EvalFrameDefault+6941>, 0x513bb7 <_PyEval_EvalFrameDefault+7655>, 
  0x51330e <_PyEval_EvalFrameDefault+5438>, 0x515b5b <_PyEval_EvalFrameDefault+15755>, 0x51683f <_PyEval_EvalFrameDefault+19055>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 
  0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x516c1b <_PyEval_EvalFrameDefault+20043>, 0x42dbd8 <_PyEval_EvalFrameDefault-934392>, 0x515018 <_PyEval_EvalFrameDefault+12872>, 
  0x514dc8 <_PyEval_EvalFrameDefault+12280>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x5154b3 <_PyEval_EvalFrameDefault+14051>, 
  0x42dafc <_PyEval_EvalFrameDefault-934612>, 0x42da5c <_PyEval_EvalFrameDefault-934772>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x51409c <_PyEval_EvalFrameDefault+8908>, 
  0x512ef6 <_PyEval_EvalFrameDefault+4390>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x513d2c <_PyEval_EvalFrameDefault+8028>, 0x512b96 <_PyEval_EvalFrameDefault+3526>, 
  0x513130 <_PyEval_EvalFrameDefault+4960>, 0x51284c <_PyEval_EvalFrameDefault+2684>, 0x5146d9 <_PyEval_EvalFrameDefault+10505>, 0x513c12 <_PyEval_EvalFrameDefault+7746>, 
  0x516ace <_PyEval_EvalFrameDefault+19710>, 0x5144f4 <_PyEval_EvalFrameDefault+10020>, 0x42e889 <_PyEval_EvalFrameDefault-931143> <repeats 18 times>, 0x516370 <_PyEval_EvalFrameDefault+17824>, 
  0x5168a7 <_PyEval_EvalFrameDefault+19159>, 0x515952 <_PyEval_EvalFrameDefault+15234>, 0x516a0d <_PyEval_EvalFrameDefault+19517>, 0x51a67b <_PyEval_EvalFrameDefault+34987>, 
  0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x51a604 <_PyEval_EvalFrameDefault+34868>, 0x513843 <_PyEval_EvalFrameDefault+6771>, 0x515401 <_PyEval_EvalFrameDefault+13873>, 
  0x516b68 <_PyEval_EvalFrameDefault+19864>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x51696c <_PyEval_EvalFrameDefault+19356>, 0x5131d8 <_PyEval_EvalFrameDefault+5128>,
  0x51445c <_PyEval_EvalFrameDefault+9868>, 0x51568c <_PyEval_EvalFrameDefault+14524>, 0x514edc <_PyEval_EvalFrameDefault+12556>, 0x5139e5 <_PyEval_EvalFrameDefault+7189>, 
  0x515364 <_PyEval_EvalFrameDefault+13716>, 0x51509a <_PyEval_EvalFrameDefault+13002>, 0x42c845 <_PyEval_EvalFrameDefault-939403>, 0x513284 <_PyEval_EvalFrameDefault+5300>, 
  0x515e87 <_PyEval_EvalFrameDefault+16567>, 0x51588c <_PyEval_EvalFrameDefault+15036>, 0x514f8a <_PyEval_EvalFrameDefault+12730>, 0x513cca <_PyEval_EvalFrameDefault+7930>, 
  0x516795 <_PyEval_EvalFrameDefault+18885>, 0x516c37 <_PyEval_EvalFrameDefault+20071>, 0x51573a <_PyEval_EvalFrameDefault+14698>, 0x516666 <_PyEval_EvalFrameDefault+18582>, 
  0x516431 <_PyEval_EvalFrameDefault+18017>, 0x516391 <_PyEval_EvalFrameDefault+17857>, 0x5157ee <_PyEval_EvalFrameDefault+14878>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 
  0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x514d1a <_PyEval_EvalFrameDefault+12106>, 0x512573 <_PyEval_EvalFrameDefault+1955>, 0x515f04 <_PyEval_EvalFrameDefault+16692>, 
  0x5165a0 <_PyEval_EvalFrameDefault+18384>, 0x5130a4 <_PyEval_EvalFrameDefault+4820>, 0x513037 <_PyEval_EvalFrameDefault+4711>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 
  0x51436e <_PyEval_EvalFrameDefault+9630>, 0x513364 <_PyEval_EvalFrameDefault+5524>, 0x5162ec <_PyEval_EvalFrameDefault+17692>, 0x5129d8 <_PyEval_EvalFrameDefault+3080>, 
  0x5126fa <_PyEval_EvalFrameDefault+2346>, 0x516207 <_PyEval_EvalFrameDefault+17463>, 0x512af8 <_PyEval_EvalFrameDefault+3368>, 0x5151ee <_PyEval_EvalFrameDefault+13342>, 
  0x516703 <_PyEval_EvalFrameDefault+18739>, 0x42ddd3 <_PyEval_EvalFrameDefault-933885>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x511fa4 <_PyEval_EvalFrameDefault+468>, 
  0x513942 <_PyEval_EvalFrameDefault+7026>, 0x512de0 <_PyEval_EvalFrameDefault+4112>, 0x5135e9 <_PyEval_EvalFrameDefault+6169>, 0x515bbe <_PyEval_EvalFrameDefault+15854>, 
  0x513b02 <_PyEval_EvalFrameDefault+7474>, 0x5121f9 <_PyEval_EvalFrameDefault+1065>, 0x5125f8 <_PyEval_EvalFrameDefault+2088>, 0x514786 <_PyEval_EvalFrameDefault+10678>, 
  0x514892 <_PyEval_EvalFrameDefault+10946>, 0x512d0f <_PyEval_EvalFrameDefault+3903>, 0x513a93 <_PyEval_EvalFrameDefault+7363>, 0x513dfd <_PyEval_EvalFrameDefault+8237>, 
  0x5128ef <_PyEval_EvalFrameDefault+2847>, 0x512176 <_PyEval_EvalFrameDefault+934>, 0x512954 <_PyEval_EvalFrameDefault+2948>, 0x51207e <_PyEval_EvalFrameDefault+686>, 
  0x5127be <_PyEval_EvalFrameDefault+2542>, 0x512c48 <_PyEval_EvalFrameDefault+3704>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 
  0x514296 <_PyEval_EvalFrameDefault+9414>, 0x512f97 <_PyEval_EvalFrameDefault+4551>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x511f30 <_PyEval_EvalFrameDefault+352>, 
  0x512008 <_PyEval_EvalFrameDefault+568>, 0x515533 <_PyEval_EvalFrameDefault+14179>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 
  0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x515a0a <_PyEval_EvalFrameDefault+15418>, 0x512284 <_PyEval_EvalFrameDefault+1204>, 0x51350d <_PyEval_EvalFrameDefault+5949>, 
  0x513445 <_PyEval_EvalFrameDefault+5749>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x514025 <_PyEval_EvalFrameDefault+8789>, 0x512d5d <_PyEval_EvalFrameDefault+3981>, 
  0x514e5b <_PyEval_EvalFrameDefault+12427>, 0x42d29c <_PyEval_EvalFrameDefault-936756>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 
  0x513675 <_PyEval_EvalFrameDefault+6309>, 0x514146 <_PyEval_EvalFrameDefault+9078>, 0x513e9c <_PyEval_EvalFrameDefault+8396>, 0x5127a2 <_PyEval_EvalFrameDefault+2514>, 
  0x5137b8 <_PyEval_EvalFrameDefault+6632>, 0x514c8e <_PyEval_EvalFrameDefault+11966>, 0x51527e <_PyEval_EvalFrameDefault+13486>, 0x5164d0 <_PyEval_EvalFrameDefault+18176>, 
  0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 
  0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42cbcf <_PyEval_EvalFrameDefault-938497>, 0x515147 <_PyEval_EvalFrameDefault+13175>, 0x514938 <_PyEval_EvalFrameDefault+11112>, 
  0x5155b9 <_PyEval_EvalFrameDefault+14313>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x42e889 <_PyEval_EvalFrameDefault-931143>, 0x512395 <_PyEval_EvalFrameDefault+1477>, 
  0x512448 <_PyEval_EvalFrameDefault+1656>, 0x514640 <_PyEval_EvalFrameDefault+10352>, 0x51617b <_PyEval_EvalFrameDefault+17323>, 0x5145a7 <_PyEval_EvalFrameDefault+10199>, 
  0x515dfd <_PyEval_EvalFrameDefault+16429>, 0x42e889 <_PyEval_EvalFrameDefault-931143> <repeats 90 times>}
PyId_displayhook = {next = 0x0, string = 0x6dcd18 "displayhook", object = 0x0}
PyId_send = {next = 0x0, string = 0x862099 "send", object = 0x0}
PyId___build_class__ = {next = 0x9119b0 <PyId___builtins__.lto_priv.0>, string = 0x6bba2c "__build_class__", object = '__build_class__'}
PyId___annotations__ = {next = 0x934a80 <PyId_copy.7>, string = 0x6a863a "__annotations__", object = '__annotations__'}
PyId___aenter__ = {next = 0x0, string = 0x6dce56 "__aenter__", object = 0x0}
PyId___aexit__ = {next = 0x0, string = 0x6dce4c "__aexit__", object = 0x0}
PyId___enter__ = {next = 0x913310 <PyId__find_and_load.7>, string = 0x6a8d72 "__enter__", object = '__enter__'}
PyId___exit__ = {next = 0x911af0 <PyId___enter__.6>, string = 0x6a8d7c "__exit__", object = '__exit__'}
```
- print code from frame
```
(gdb) py-list
 512    _string_at = PYFUNCTYPE(py_object, c_void_p, c_int)(_string_at_addr)
 513    def string_at(ptr, size=-1):
 514        """string_at(addr[, size]) -> string
 515    
 516        Return the string at addr."""
>517        return _string_at(ptr, size)
 518    
 519    try:
 520        from _ctypes import _wstring_at_addr
 521    except ImportError:
 522        pass
```
- print local vars from frame
```
(gdb) py-locals
ptr = 0
size = -1
```