## understand plt + got code examples

### compile example program without pie
```
robert@laptop:~$ gcc plt_demo.c -o plt_demo -no-pie
```

### run program with breakpoint before call to puts
```
robert@laptop:~$ gdb -q plt_demo
gdb-peda$ b *main+11
gdb-peda$ r
[...]
0x4005cd <main+11>: call   0x401030 <puts@plt>
[...]
```
- call to fct puts calls puts@plt

### check that address of fct all is in plt range
```
robert@laptop:~$ objdump plt_demo -h
[...]
Idx Name          Size      VMA               LMA               File off  Algn
 11 .plt          00000030  0000000000401020  0000000000401020  00001020  2**4
[...]
 20 .got          00000020  0000000000403fe0  0000000000403fe0  00002fe0  2**3
 21 .got.plt      00000028  0000000000404000  0000000000404000  00003000  2**3
 [...]
```

### debug again, run 'si' after start, inspect pointer address
```
robert@laptop:~$ gdb -q plt_demo
gdb-peda$ b *main+11
gdb-peda$ r
gdb-peda$ si
[...]
   0x401021:    xor    eax,0x2fe2
   0x401026:    jmp    QWORD PTR [rip+0x2fe4]        # 0x404010
   0x40102c:    nop    DWORD PTR [rax+0x0]
=> 0x401030 <puts@plt>:
 | jmp    QWORD PTR [rip+0x2fe2]        # 0x404018 <puts@got.plt>
 | 0x401036 <puts@plt+6>:       push   0x0
 | 0x40103b <puts@plt+11>:      jmp    0x401020
 | 0x401040 <system@plt>::       | 0x401040 <system@plt>:
 | jmp    QWORD PTR [rip+0x2fda]        # 0x404020 <system@got.plt>
 | 0x401046 <system@plt+6>:     push   0x1
 |->   0x401036 <puts@plt+6>:   push   0x0
       0x40103b <puts@plt+11>:  jmp    0x401020
       0x401040 <system@plt>:
       jmp    QWORD PTR [rip+0x2fda]        # 0x404020 <system@got.plt>
       0x401046 <system@plt+6>: push   0x1
[...]
gdb-peda$ x/gx 0x404018
0x404018 <puts@got.plt>:        0x0000000000401036
```

### check where last jump points to
```
gdb-peda$ x/gx 0x404010
0x404010:       0x00007ffff7fe7d30
gdb-peda$ x/5i 0x00007ffff7fe7d30
   0x7ffff7fe7d30 <_dl_runtime_resolve_xsavec>: endbr64 
   0x7ffff7fe7d34 <_dl_runtime_resolve_xsavec+4>:       push   rbx
   0x7ffff7fe7d35 <_dl_runtime_resolve_xsavec+5>:       mov    rbx,rsp
   0x7ffff7fe7d38 <_dl_runtime_resolve_xsavec+8>:       and    rsp,0xffffffffffffffc0
   0x7ffff7fe7d3c <_dl_runtime_resolve_xsavec+12>:      sub    rsp,QWORD PTR [rip+0x1487d]        # 0x7ffff7ffc5c0 <_rtld_local_ro+352>
gdb-peda$ vmmap
[...]
0x00007ffff7fd0000 0x00007ffff7fd2000 r--p      /usr/lib/ld-2.32.so
0x00007ffff7fd2000 0x00007ffff7ff3000 r-xp      /usr/lib/ld-2.32.so
0x00007ffff7ff3000 0x00007ffff7ffc000 r--p      /usr/lib/ld-2.32.so
0x00007ffff7ffc000 0x00007ffff7ffd000 r--p      /usr/lib/ld-2.32.so
0x00007ffff7ffd000 0x00007ffff7fff000 rw-p      /usr/lib/ld-2.32.so
[...]
```
```
gdb-peda$ n
gdb-peda$ n
gdb-peda$ si
[...]
=> 0x401026:    jmp    QWORD PTR [rip+0x2fe4]        # 0x404010
 | 0x40102c:    nop    DWORD PTR [rax+0x0]
 | 0x401030 <puts@plt>: jmp    QWORD PTR [rip+0x2fe2]        # 0x404018 <puts@got.plt>
 | 0x401036 <puts@plt+6>:       push   0x0
 | 0x40103b <puts@plt+11>:      jmp    0x401020
 |->   0x7ffff7fe7d30 <_dl_runtime_resolve_xsavec>:     endbr64 
       0x7ffff7fe7d34 <_dl_runtime_resolve_xsavec+4>:   push   rbx
       0x7ffff7fe7d35 <_dl_runtime_resolve_xsavec+5>:   mov    rbx,rsp
       0x7ffff7fe7d38 <_dl_runtime_resolve_xsavec+8>:   and    rsp,0xffffffffffffffc0
[...]
```

### ld.so
```
DESCRIPTION
       The programs ld.so and ld-linux.so* find and load the shared objects (shared libraries) needed by a program,
       prepare the program to run, and then run it.
       Linux binaries require dynamic linking (linking at run time) unless the -static option was given to ld(1) during compilation.
```

## return to plt

### compile vulnerable program without stack canary and pie
```
robert@laptop:~$ gcc ret2plt.c -o ret2plt -fno-stack-protector -no-pie
```

### run program on server (localhost)
```
robert@laptop:~$ sudo socat tcp-listen:5556,reuseaddr,fork, exec:"./ret2plt"
```

### find gadget for 'pop rdi; ret'
```
robert@laptop:~$ ropper --file /lib/libc-2.32.so --search "pop rdi; ret"
[...]
0x00000000001228fa: pop rdi; ret;
```

### find string sh
```
gdb-peda$ b *main+63
Breakpoint 1 at 0x4011a5
gdb-peda$ r
gdb-peda$ find sh
Searching for 'sh' in: None ranges
Found 110 results, display max 110 items:
   ret2plt : 0x402051 --> 0xa00000000006873 ('sh')
   ret2plt : 0x403051 --> 0xa00000000006873 ('sh')
[...]
```

### find offset of return address
- 120 

### fill addresses in script (system@plt given in gdb output above)

### todo: script not working